#import "CityManager.h"
#import <Foundation/Foundation.h>
#import "DYYYConstants.h"

@implementation CityManager

+ (instancetype)sharedInstance {
    static CityManager *instance = nil;
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
      instance = [[CityManager alloc] init];
      [instance loadCityData];
    });
    return instance;
}

- (void)loadCityData {
    self.cityCodeMap = @{
        @"110000" : @"北京",
        @"110100" : @"北京",
        @"120000" : @"天津",
        @"120100" : @"天津",
        @"130000" : @"河北",
        @"130100" : @"石家莊",
        @"130200" : @"唐山",
        @"130300" : @"秦皇島",
        @"130400" : @"邯鄲",
        @"130500" : @"邢台",
        @"130600" : @"保定",
        @"130700" : @"張家口",
        @"130800" : @"承德",
        @"130900" : @"滄州",
        @"131000" : @"廊坊",
        @"131100" : @"衡水",
        @"140000" : @"山西",
        @"140100" : @"太原",
        @"140200" : @"大同",
        @"140300" : @"陽泉",
        @"140400" : @"長治",
        @"140500" : @"晉城",
        @"140600" : @"朔州",
        @"140700" : @"晉中",
        @"140800" : @"運城",
        @"140900" : @"忻州",
        @"141000" : @"臨汾",
        @"141100" : @"呂梁",
        @"150000" : @"內蒙古",
        @"150100" : @"呼和浩特",
        @"150200" : @"包頭",
        @"150300" : @"烏海",
        @"150400" : @"赤峰",
        @"150500" : @"通遼",
        @"150600" : @"鄂爾多斯",
        @"150700" : @"呼倫貝爾",
        @"150800" : @"巴彥淖爾",
        @"150900" : @"烏蘭察布",
        @"152200" : @"興安",
        @"152500" : @"錫林郭勒",
        @"152900" : @"阿拉善",
        @"210000" : @"遼寧",
        @"210100" : @"瀋陽",
        @"210200" : @"大連",
        @"210300" : @"鞍山",
        @"210400" : @"撫順",
        @"210500" : @"本溪",
        @"210600" : @"丹東",
        @"210700" : @"錦州",
        @"210800" : @"營口",
        @"210900" : @"阜新",
        @"211000" : @"遼陽",
        @"211100" : @"盤錦",
        @"211200" : @"鐵嶺",
        @"211300" : @"朝陽",
        @"211400" : @"葫蘆島",
        @"220000" : @"吉林",
        @"220100" : @"長春",
        @"220200" : @"吉林",
        @"220300" : @"四平",
        @"220400" : @"遼源",
        @"220500" : @"通化",
        @"220600" : @"白山",
        @"220700" : @"松原",
        @"220800" : @"白城",
        @"222400" : @"延邊",
        @"230000" : @"黑龍江",
        @"230100" : @"哈爾濱",
        @"230200" : @"齊齊哈爾",
        @"230300" : @"雞西",
        @"230400" : @"鶴崗",
        @"230500" : @"雙鴨山",
        @"230600" : @"大慶",
        @"230700" : @"伊春",
        @"230800" : @"佳木斯",
        @"230900" : @"七台河",
        @"231000" : @"牡丹江",
        @"231100" : @"黑河",
        @"231200" : @"綏化",
        @"232700" : @"大興安嶺",
        @"310000" : @"上海",
        @"310100" : @"上海",
        @"320000" : @"江蘇",
        @"320100" : @"南京",
        @"320200" : @"無錫",
        @"320300" : @"徐州",
        @"320400" : @"常州",
        @"320500" : @"蘇州",
        @"320600" : @"南通",
        @"320700" : @"連雲港",
        @"320800" : @"淮安",
        @"320900" : @"鹽城",
        @"321000" : @"揚州",
        @"321100" : @"鎮江",
        @"321200" : @"泰州",
        @"321300" : @"宿遷",
        @"330000" : @"浙江",
        @"330100" : @"杭州",
        @"330200" : @"寧波",
        @"330300" : @"溫州",
        @"330400" : @"嘉興",
        @"330500" : @"湖州",
        @"330600" : @"紹興",
        @"330700" : @"金華",
        @"330800" : @"衢州",
        @"330900" : @"舟山",
        @"331000" : @"台州",
        @"331100" : @"麗水",
        @"340000" : @"安徽",
        @"340100" : @"合肥",
        @"340200" : @"蕪湖",
        @"340300" : @"蚌埠",
        @"340400" : @"淮南",
        @"340500" : @"馬鞍山",
        @"340600" : @"淮北",
        @"340700" : @"銅陵",
        @"340800" : @"安慶",
        @"341000" : @"黃山",
        @"341100" : @"滁州",
        @"341200" : @"阜陽",
        @"341300" : @"宿州",
        @"341500" : @"六安",
        @"341600" : @"亳州",
        @"341700" : @"池州",
        @"341800" : @"宣城",
        @"350000" : @"福建",
        @"350100" : @"福州",
        @"350200" : @"廈門",
        @"350300" : @"莆田",
        @"350400" : @"三明",
        @"350500" : @"泉州",
        @"350600" : @"漳州",
        @"350700" : @"南平",
        @"350800" : @"龍岩",
        @"350900" : @"寧德",
        @"360000" : @"江西",
        @"360100" : @"南昌",
        @"360200" : @"景德鎮",
        @"360300" : @"萍鄉",
        @"360400" : @"九江",
        @"360500" : @"新余",
        @"360600" : @"鷹潭",
        @"360700" : @"贛州",
        @"360800" : @"吉安",
        @"360900" : @"宜春",
        @"361000" : @"撫州",
        @"361100" : @"上饒",
        @"370000" : @"山東",
        @"370100" : @"濟南",
        @"370200" : @"青島",
        @"370300" : @"淄博",
        @"370400" : @"棗莊",
        @"370500" : @"東營",
        @"370600" : @"煙台",
        @"370700" : @"濰坊",
        @"370800" : @"濟寧",
        @"370900" : @"泰安",
        @"371000" : @"威海",
        @"371100" : @"日照",
        @"371200" : @"萊蕪",
        @"371300" : @"臨沂",
        @"371400" : @"德州",
        @"371500" : @"聊城",
        @"371600" : @"濱州",
        @"371700" : @"菏澤",
        @"410000" : @"河南",
        @"410100" : @"鄭州",
        @"410200" : @"開封",
        @"410300" : @"洛陽",
        @"410400" : @"平頂山",
        @"410500" : @"安陽",
        @"410600" : @"鶴壁",
        @"410700" : @"新鄉",
        @"410800" : @"焦作",
        @"410900" : @"濮陽",
        @"411000" : @"許昌",
        @"411100" : @"漯河",
        @"411200" : @"三門峽",
        @"411300" : @"南陽",
        @"411400" : @"商丘",
        @"411500" : @"信陽",
        @"411600" : @"周口",
        @"411700" : @"駐馬店",
        @"419001" : @"濟源",
        @"420000" : @"湖北",
        @"420100" : @"武漢",
        @"420200" : @"黃石",
        @"420300" : @"十堰",
        @"420500" : @"宜昌",
        @"420600" : @"襄陽",
        @"420700" : @"鄂州",
        @"420800" : @"荊門",
        @"420900" : @"孝感",
        @"421000" : @"荊州",
        @"421100" : @"黃岡",
        @"421200" : @"咸寧",
        @"421300" : @"隨州",
        @"422800" : @"恩施",
        @"429004" : @"仙桃",
        @"429005" : @"潛江",
        @"429006" : @"天門",
        @"429021" : @"神農架",
        @"430000" : @"湖南",
        @"430100" : @"長沙",
        @"430200" : @"株洲",
        @"430300" : @"湘潭",
        @"430400" : @"衡陽",
        @"430500" : @"邵陽",
        @"430600" : @"岳陽",
        @"430700" : @"常德",
        @"430800" : @"張家界",
        @"430900" : @"益陽",
        @"431000" : @"郴州",
        @"431100" : @"永州",
        @"431200" : @"懷化",
        @"431300" : @"婁底",
        @"433100" : @"湘西",
        @"440000" : @"廣東",
        @"440100" : @"廣州",
        @"440200" : @"韶關",
        @"440300" : @"深圳",
        @"440400" : @"珠海",
        @"440500" : @"汕頭",
        @"440600" : @"佛山",
        @"440700" : @"江門",
        @"440800" : @"湛江",
        @"440900" : @"茂名",
        @"441200" : @"肇慶",
        @"441300" : @"惠州",
        @"441400" : @"梅州",
        @"441500" : @"汕尾",
        @"441600" : @"河源",
        @"441700" : @"陽江",
        @"441800" : @"清遠",
        @"441900" : @"東莞",
        @"442000" : @"中山",
        @"445100" : @"潮州",
        @"445200" : @"揭陽",
        @"445300" : @"雲浮",
        @"450000" : @"廣西",
        @"450100" : @"南寧",
        @"450200" : @"柳州",
        @"450300" : @"桂林",
        @"450400" : @"梧州",
        @"450500" : @"北海",
        @"450600" : @"防城港",
        @"450700" : @"欽州",
        @"450800" : @"貴港",
        @"450900" : @"玉林",
        @"451000" : @"百色",
        @"451100" : @"賀州",
        @"451200" : @"河池",
        @"451300" : @"來賓",
        @"451400" : @"崇左",
        @"460000" : @"海南",
        @"460100" : @"海口",
        @"460200" : @"三亞",
        @"460300" : @"三沙",
        @"460400" : @"儋州",
        @"469001" : @"五指山",
        @"469002" : @"瓊海",
        @"469005" : @"文昌",
        @"469006" : @"萬寧",
        @"469007" : @"東方",
        @"469021" : @"定安",
        @"469022" : @"屯昌",
        @"469023" : @"澄邁",
        @"469024" : @"臨高",
        @"469025" : @"白沙",
        @"469026" : @"昌江",
        @"469027" : @"樂東",
        @"469028" : @"陵水",
        @"469029" : @"保亭",
        @"469030" : @"瓊中",
        @"500000" : @"重慶",
        @"500100" : @"重慶",
        @"510000" : @"四川",
        @"510100" : @"成都",
        @"510300" : @"自貢",
        @"510400" : @"攀枝花",
        @"510500" : @"盧州",
        @"510600" : @"德陽",
        @"510700" : @"綿陽",
        @"510800" : @"廣元",
        @"510900" : @"遂寧",
        @"511000" : @"內江",
        @"511100" : @"樂山",
        @"511300" : @"南充",
        @"511400" : @"眉山",
        @"511500" : @"宜賓",
        @"511600" : @"廣安",
        @"511700" : @"達州",
        @"511800" : @"雅安",
        @"511900" : @"巴中",
        @"512000" : @"資陽",
        @"513200" : @"阿壩",
        @"513300" : @"甘孜",
        @"513400" : @"涼山",
        @"520000" : @"貴州",
        @"520100" : @"貴陽",
        @"520200" : @"六盤水",
        @"520300" : @"遵義",
        @"520400" : @"安順",
        @"520500" : @"畢節",
        @"520600" : @"銅仁",
        @"522300" : @"黔西南",
        @"522600" : @"黔東南",
        @"522700" : @"黔南",
        @"530000" : @"雲南",
        @"530100" : @"昆明",
        @"530300" : @"曲靖",
        @"530400" : @"玉溪",
        @"530500" : @"保山",
        @"530600" : @"昭通",
        @"530700" : @"麗江",
        @"530800" : @"普洱",
        @"530900" : @"臨滄",
        @"532300" : @"楚雄",
        @"532500" : @"紅河",
        @"532600" : @"文山",
        @"532800" : @"西雙版納",
        @"532900" : @"大理",
        @"533100" : @"德宏",
        @"533300" : @"怒江",
        @"533400" : @"迪慶",
        @"540000" : @"西藏",
        @"540100" : @"拉薩",
        @"540200" : @"日喀則",
        @"540300" : @"昌都",
        @"540400" : @"林芝",
        @"540500" : @"山南",
        @"542400" : @"那曲",
        @"542500" : @"阿里",
        @"610000" : @"陝西",
        @"610100" : @"西安",
        @"610200" : @"銅川",
        @"610300" : @"寶雞",
        @"610400" : @"咸陽",
        @"610500" : @"渭南",
        @"610600" : @"延安",
        @"610700" : @"漢中",
        @"610800" : @"榆林",
        @"610900" : @"安康",
        @"611000" : @"商洛",
        @"620000" : @"甘肅",
        @"620100" : @"蘭州",
        @"620200" : @"嘉峪關",
        @"620300" : @"金昌",
        @"620400" : @"白銀",
        @"620500" : @"天水",
        @"620600" : @"武威",
        @"620700" : @"張掖",
        @"620800" : @"平涼",
        @"620900" : @"酒泉",
        @"621000" : @"慶陽",
        @"621100" : @"定西",
        @"621200" : @"隴南",
        @"622900" : @"臨夏",
        @"623000" : @"甘南",
        @"630000" : @"青海",
        @"630100" : @"西寧",
        @"630200" : @"海東",
        @"632200" : @"海北",
        @"632300" : @"黃南",
        @"632500" : @"海南",
        @"632600" : @"果洛",
        @"632700" : @"玉樹",
        @"632800" : @"海西",
        @"640000" : @"寧夏",
        @"640100" : @"銀川",
        @"640200" : @"石嘴山",
        @"640300" : @"吳忠",
        @"640400" : @"固原",
        @"640500" : @"中衛",
        @"650000" : @"新疆",
        @"650100" : @"烏魯木齊",
        @"650200" : @"克拉瑪依",
        @"650400" : @"吐魯番",
        @"650500" : @"哈密",
        @"652300" : @"昌吉",
        @"652700" : @"博爾塔拉",
        @"652800" : @"巴音郭楞",
        @"652900" : @"阿克蘇",
        @"653000" : @"克孜勒蘇",
        @"653100" : @"喀什",
        @"653200" : @"和田",
        @"654000" : @"伊犁",
        @"654200" : @"塔城",
        @"654300" : @"阿勒泰",
        @"659001" : @"石河子",
        @"659002" : @"阿拉爾",
        @"659003" : @"圖木舒克",
        @"659004" : @"五家渠",
        @"659005" : @"北屯",
        @"659006" : @"鐵門關",
        @"659007" : @"雙河",
        @"659008" : @"可克達拉",
        @"710000" : @"臺灣",
        @"710100" : @"台北",
        @"710200" : @"高雄",
        @"710300" : @"台中",
        @"710400" : @"台北",
        @"710500" : @"桃園",
        @"710600" : @"台南",
        @"710700" : @"彰化",
        @"710800" : @"屏東",
        @"710900" : @"雲林",
        @"711000" : @"苗栗",
        @"711100" : @"臺灣",
        @"711200" : @"嘉義縣",
        @"711300" : @"南投",
        @"711400" : @"宜蘭",
        @"711500" : @"臺灣",
        @"711600" : @"臺灣",
        @"711700" : @"花蓮",
        @"711800" : @"嘉義市",
        @"711900" : @"台東",
        @"712100" : @"澎湖",
        @"810000" : @"香港",
        @"810100" : @"香港島",
        @"810200" : @"九龍",
        @"810300" : @"新界",
        @"820000" : @"澳門",
        @"820100" : @"澳門半島",
        @"820200" : @"氹仔",
        @"820300" : @"路環",
        @"820400" : @"無堂",
        @"820500" : @"澳門",
        @"820600" : @"澳門",
        @"820700" : @"澳門",
    };
}

- (NSString *)getCityNameWithCode:(NSString *)code {
    if (!code || code.length < 6) {
        return nil;
    }

    NSString *cityName = self.cityCodeMap[code];

    return cityName;
}

- (NSString *)getProvinceNameWithCode:(NSString *)code {
    if (!code || code.length < 6) {
        return nil;
    }
    NSString *provinceCode = [code substringToIndex:2];
    provinceCode = [provinceCode stringByAppendingString:@"0000"];
    NSString *provinceCodeName = self.cityCodeMap[provinceCode];

    return provinceCodeName;
}

+ (void)fetchLocationWithGeonameId:(NSString *)geonameId completionHandler:(void (^)(NSDictionary *locationInfo, NSError *error))completionHandler {
    if (geonameId.length == 0) {
        if (completionHandler) {
            NSError *parameterError = [NSError errorWithDomain:DYYYGeonamesErrorDomain code:-2 userInfo:@{NSLocalizedDescriptionKey : @"GeoNames 参数无效"}];
            completionHandler(nil, parameterError);
        }
        return;
    }

    NSString *username = [[NSUserDefaults standardUserDefaults] stringForKey:@"DYYYGeonamesUsername"];
    if (!username || [username length] == 0) {
        username = @"your_username";
    }

    NSCharacterSet *allowedSet = [NSCharacterSet URLQueryAllowedCharacterSet];
    NSString *encodedGeonameId = [geonameId stringByAddingPercentEncodingWithAllowedCharacters:allowedSet];
    NSString *encodedUsername = [username stringByAddingPercentEncodingWithAllowedCharacters:allowedSet];
    if (!encodedGeonameId || !encodedUsername) {
        if (completionHandler) {
            NSError *encodingError = [NSError errorWithDomain:DYYYGeonamesErrorDomain code:-3 userInfo:@{NSLocalizedDescriptionKey : @"GeoNames 参数编码失败"}];
            completionHandler(nil, encodingError);
        }
        return;
    }

    NSString *urlString = [NSString stringWithFormat:@"https://secure.geonames.org/getJSON?geonameId=%@&lang=zh&username=%@", encodedGeonameId, encodedUsername];
    NSURL *url = [NSURL URLWithString:urlString];

    NSURLSessionDataTask *task = [[NSURLSession sharedSession] dataTaskWithURL:url
                                                             completionHandler:^(NSData *data, NSURLResponse *response, NSError *error) {
                                                               if (error) {
                                                                   completionHandler(nil, error);
                                                                   return;
                                                               }

                                                               NSHTTPURLResponse *httpResponse = (NSHTTPURLResponse *)response;
                                                               if (httpResponse.statusCode != 200) {
                                                                   completionHandler(nil, [NSError errorWithDomain:@"com.dyyy.api" code:httpResponse.statusCode userInfo:nil]);
                                                                   return;
                                                               }

                                                               NSError *jsonError;
                                                               NSDictionary *jsonResult = [NSJSONSerialization JSONObjectWithData:data options:0 error:&jsonError];

                                                               if (jsonError) {
                                                                   completionHandler(nil, jsonError);
                                                                   return;
                                                               }

                                                               NSDictionary *status = jsonResult[@"status"];
                                                               if (status && [status isKindOfClass:[NSDictionary class]]) {
                                                                   NSNumber *value = status[@"value"];
                                                                   NSInteger statusCode = value != nil ? value.integerValue : -1;
                                                                   NSString *message = status[@"message"] ?: @"the geoname feature does not exist.";

                                                                   NSMutableDictionary *userInfo = [NSMutableDictionary dictionary];
                                                                   userInfo[NSLocalizedDescriptionKey] = message;
                                                                   userInfo[DYYYGeonamesStatusUserInfoKey] = status;
                                                                   if (geonameId) {
                                                                       userInfo[@"geonameId"] = geonameId;
                                                                   }

                                                                   NSError *apiError = [NSError errorWithDomain:DYYYGeonamesErrorDomain code:statusCode userInfo:userInfo];
                                                                   completionHandler(nil, apiError);
                                                                   return;
                                                               }

                                                               completionHandler(jsonResult, nil);
                                                             }];

    [task resume];
}
@end
